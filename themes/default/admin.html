<!DOCTYPE html>
<html>

<head>
    <title id="title"></title>
    <link rel="stylesheet" type="text/css" href="static/style.css">
    <link rel="stylesheet" type="text/css" href="static/fonts.css">
    <script src="static/js-yaml.min.js"></script>
    <script src="static/showdown.min.js"></script>
    <link rel="icon" type="image/svg" href="static/img/logo.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"
        integrity="sha512-GoORoNnxst42zE3rYPj4bNBm0Q6ZRXKNH2D9nEmNvVF/z24ywVnijAWVi/09iBiVDQVf3UlZHpzhAJIdd9BXqw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.min.js"
        integrity="sha512-8qx1DL/2Wsrrij2TWX5UzvEaYOFVndR7BogdpOyF4ocMfnfkw28qt8ULkXD9Tef0bLvh3TpnSAljDC7uyniEuQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-markdown.min.js"
        integrity="sha512-8euv05RhbuOcZWj/kpF+KtKN7g1CPx7buTZjIBf/rZQz47cduH3DERWoqJFrIYE0TzaIlptz+Ir2BodrmLT8kQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-tomorrow_night_eighties.min.js"
        integrity="sha512-ZpoDdz3A/zV2aKTjH8fcyDKhg+zOuu423OkuJ7SvK1jMRZUSkTtH1YQQS10pqNvi9CYT2jmtOCxuNQW9TEtHdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<top id="top" />

<body>
    <div class="menu">
        <a href="index.html" class="menuBtn title" id="titlebtn"></a>
        <a class="menuBtn" href="blog.html">Blog</a>
        <a class="menuBtn" href="about.html">About</a>
    </div>

    <script>
        fetch('settings.yaml')
            .then(response => response.text())
            .then(data => {
                // Do something with your data
                var doc = jsyaml.load(data);
                document.getElementsByTagName("footer")[0].innerHTML = doc.settings.copyright_info;
                document.getElementById("title").innerHTML = doc.settings.site_name;
                document.getElementById("titlebtn").innerHTML = doc.settings.site_name;
            });
    </script>

    <div class="filesbar" id="filePanel" data-open="false">
        <details id="postlist">
            <summary>
                <h2 style="display: inline;">Posts</h2>
            </summary>

        </details>

        <input type="text" id="author" value="John Smith"><br>

        <input type="text" id="date" value="8/4/2021"><br>

        <a href="#" onclick="createPost();">New Post +</a>

        <a href="#" id="openclose" onclick="togglePanel();">
            ▶
        </a>
        <a target="_blank" id="exportYaml">Export yaml</a>
    </div>

    <div class="editorcontainer">
        <div id="pane-left">
                <input type="text" id="name" value="It works!"><br>

            <div class="ace-editor" id="editor" style="margin-top: 0%; height: 100%; width: 100%;">Hello world!</div>
            
            <div class="horiz">
                <label for="featured_image" id="ftrlbl">Featured Image:</label>
                <input type="text" id="featured_image" value="none">
            </div>
        </div>
        <div id="pane-right">

        </div>

    </div>


</body>

<script>
    const postlist = document.querySelector("#postlist");
    const panel = document.querySelector("#filePanel");
    const openclose = document.querySelector("#openclose");
    var postsObj = null;


    fetch('posts.json')
    .then(response => response.text())
    .then(data => {
        // Do something with your data
        postsObj = JSON.parse(data);
        setInterval(makeButtons(), 500);
    });


    function makeButtons() {
        for (const post of postsObj.posts) {
                var postbutton = document.createElement('a');
                postbutton.className = "markBtn";
                postbutton.onclick = function() {loadPost(post);}
                postbutton.href = "#";
                postbutton.innerHTML = `${post.name}`;
                postlist.appendChild(postbutton);
            }
    }
    
    var renderJob = null;
    function loadPost(thePost) {
        document.getElementById("name").value = thePost.name;
        document.getElementById("author").value = thePost.author;
        document.getElementById("date").value = thePost.date;
        document.getElementById("featured_image").value = thePost.featured_image;
        editor.getSession().setValue(thePost.content);

        clearInterval(renderJob);
        renderjob = setInterval(function() {render(thePost)}, 500);
    }

    const d = new Date();
    function createPost() {
        id = postsObj.posts.length + 1;

        var newPost = {
            name : "New Post",
            author : "Author",
            date : d.getMonth()+1 + "/" + d.getDate() + "/" + d.getFullYear(),
            featured_image: "none",
            content : "Type here..."
        };
        postsObj.posts.unshift(newPost);
        
        loadPost(newPost);
    }

    function togglePanel() {
        if (panel.dataset.open == "true") {
            panel.dataset.open = "false";
            openclose.innerHTML = "▶";
        } else {
            panel.dataset.open = "true";
            openclose.innerHTML = "◀";
        }
    }

    var element = document.getElementById("editor");
    var editor = ace.edit(element, {
        mode: "ace/mode/markdown",
        theme: "ace/theme/tomorrow_night_eighties",
        keyboardHandler: "ace/keyboard/vscode",
        printMargin: false,
        fontSize: "13pt",
        behavioursEnabled: true,
        wrap: true,
        selectionStyle: "text"
    });
    editor.resize();

    var rightPane = document.getElementById("pane-right");

    var innerpane = document.createElement("div");
    innerpane.innerHTML = `
                <div class="landing preview">
                    <div class="jumbo" id="featuredImg" style="background-image: url('');"></div>
                    <div class="innerLanding" style="margin-top: -5pt;">
                        <h1>Title</h1>
                        HTML
                    </div>
                    <p class="published">Published</p>
                </div>
                `;
    rightPane.appendChild(innerpane);

    
    var markdown = "";
    var converter = new showdown.Converter();

    var name = "";
    var author = "";
    var date = "";
    var featured_image = "";

    function render(post) {
        name = document.getElementById("name").value;
        author = document.getElementById("author").value;
        date = document.getElementById("date").value;
        featured_image = document.getElementById("featured_image").value;

        markdown = editor.getValue();
        var markdown_html = converter.makeHtml(markdown);

        if (featured_image == "none") {
            var img = "";
        }
        else {
            var img = `<div class="jumbo" style="background-image: url('${featured_image}');"></div>`
        }

        document.getElementById("pane-right").innerHTML = `
        <div class="landingPreview">
            ${img}
            <div class="innerLanding" style="margin-top: -5pt;">
                <h1>${name}</h1>
                    ${markdown_html}
            </div>
            <p class="published">Published ${date} by ${author}</p>
        </div>
        `;
        
        post.name = name;
        post.author = author;
        post.date = date;
        post.featured_image = featured_image;
        post.content = editor.getValue();

        postsJSON = JSON.stringify(postsObj, null, 2);
        postsJSON = btoa(postsJSON);

        document.getElementById("exportYaml").setAttribute("download", "export.json");
        document.getElementById("exportYaml").setAttribute("href", `data:text/plain;base64,${postsJSON}`);
    }

    function exportYaml() {

    }

</script>

<footer>
</footer>

</html>